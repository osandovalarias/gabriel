<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guías de Despacho - MVC-CONTOPSA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #5c6bc0;
            --secondary-color: #3949ab;
            --accent-color: #7986cb;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 95%;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            text-align: center;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 500;
        }

        .btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: var(--box-shadow);
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--warning-color);
        }

        .btn-danger:hover {
            background-color: #d3165e;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #3aa8d8;
        }

        .btn-sm {
            padding: 0.3rem 0.7rem;
            font-size: 0.9rem;
        }

        .table-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow-x: auto;
            margin-bottom: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .info-text {
            color: #6c757d;
            font-style: italic;
            margin-bottom: 1rem;
        }

        .file-input-container {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .file-input-label {
            display: inline-block;
            padding: 0.7rem 1.5rem;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background-color: #3aa8d8;
        }

        .file-input {
            display: none;
        }

        .file-name {
            font-size: 0.9rem;
            color: var(--dark-color);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .password-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 400px;
        }

        .password-input {
            width: 100%;
            padding: 0.8rem;
            margin: 1rem 0;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Nuevos estilos para las mejoras */
        .summary-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1rem;
            flex: 1;
            min-width: 200px;
        }

        .summary-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .summary-card p {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .date-filter-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .date-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-filter label {
            font-weight: 500;
        }

        .date-filter input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        .destinatarios-container, .transportistas-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .destinatarios-list, .transportistas-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .destinatario-tag, .transportista-tag {
            background-color: var(--accent-color);
            color: white;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .scroll-top-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--box-shadow);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 999;
        }

        .scroll-top-btn.visible {
            opacity: 1;
        }

        .btn-export {
            background-color: #4caf50;
        }

        .btn-export:hover {
            background-color: #3e8e41;
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 0 0.5rem;
            }
            
            .file-input-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            th, td {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

            .date-filter-container {
                flex-direction: column;
            }

            .date-filter {
                width: 100%;
            }

            .date-filter input {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Guías de Despacho - <span id="fechaCierre"></span></h1>
        </header>

        <div class="file-input-container">
            <label for="excelFile" class="file-input-label">
                <i class="fas fa-file-excel"></i> Cargar Excel
            </label>
            <span id="fileName" class="file-name">No se ha seleccionado archivo</span>
            <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls, .csv">
            <button class="btn btn-danger" id="clearData">
                <i class="fas fa-trash"></i> Limpiar Todo
            </button>
            <button class="btn btn-export" id="exportExcel">
                <i class="fas fa-download"></i> Exportar Excel
            </button>
        </div>

        <!-- Filtros por fecha -->
        <div class="date-filter-container">
            <div class="date-filter">
                <label for="fechaDesde">Desde:</label>
                <input type="date" id="fechaDesde">
            </div>
            <div class="date-filter">
                <label for="fechaHasta">Hasta:</label>
                <input type="date" id="fechaHasta">
            </div>
            <button class="btn" id="aplicarFiltro">Aplicar Filtro</button>
            <button class="btn btn-danger" id="limpiarFiltro">Limpiar Filtro</button>
        </div>

        <!-- Resumen de datos -->
        <div class="summary-container">
            <div class="summary-card">
                <h3>Guías Totales</h3>
                <p id="totalGuias">0</p>
            </div>
            <div class="summary-card">
                <h3>Guías Vigentes</h3>
                <p id="guiasVigentes">0</p>
            </div>
            <div class="summary-card">
                <h3>Guías Anuladas</h3>
                <p id="guiasAnuladas">0</p>
            </div>
            <div class="summary-card">
                <h3>Total Sellos</h3>
                <p id="totalSellos">0</p>
            </div>
            <div class="summary-card">
                <h3>Total Peso Neto</h3>
                <p id="totalPesoNeto">0</p>
            </div>
        </div>

        <!-- Listado de destinatarios -->
        <div class="destinatarios-container">
            <h3>Destinatarios</h3>
            <div class="destinatarios-list" id="destinatariosList">
                <span class="destinatario-tag">No hay datos</span>
            </div>
        </div>

        <!-- Listado de transportistas -->
        <div class="transportistas-container">
            <h3>Transportistas</h3>
            <div class="transportistas-list" id="transportistasList">
                <span class="transportista-tag">No hay datos</span>
            </div>
        </div>

        <!-- Tabla de guías -->
        <div class="table-container">
            <table id="sheet2Table">
                <thead>
                    <tr>
                        <th>Nro Guía</th>
                        <th>Fecha Emisión</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Operador</th>
                        <th>Destinatario</th>
                        <th>Transportista</th>
                        <th>Conductor</th>
                        <th>Pat. Camión</th>
                        <th>Pat. Acoplado</th>
                        <th>Producto</th>
                        <th>Peso Bruto</th>
                        <th>Peso Tara</th>
                        <th>Peso Neto</th>
                        <th>Sellos</th>
                    </tr>
                </thead>
                <tbody id="sheet2TableBody">
                    <tr>
                        <td colspan="15" style="text-align: center;">No hay datos disponibles. Cargue un archivo Excel.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p class="info-text">Detalle de guías de despacho</p>
    </div>

    <!-- Botón para ir al principio -->
    <div class="scroll-top-btn" id="scrollTopBtn">
        <i class="fas fa-arrow-up"></i>
    </div>

    <!-- Modal para contraseña -->
    <div class="password-modal" id="passwordModal">
        <div class="password-modal-content">
            <h2>Confirmar eliminación</h2>
            <p>Ingrese la contraseña para eliminar todos los datos:</p>
            <input type="password" id="passwordInput" class="password-input" placeholder="Contraseña">
            <div class="modal-buttons">
                <button class="btn" id="cancelDelete">Cancelar</button>
                <button class="btn btn-danger" id="confirmDelete">Eliminar</button>
            </div>
            <p id="passwordError" style="color: var(--warning-color); margin-top: 1rem; display: none;">Contraseña incorrecta. Intente nuevamente.</p>
        </div>
    </div>

    <script>
        // Datos en memoria
        let guiasData = [];
        let filteredData = [];
        
        // Elementos del DOM
        const excelFileInput = document.getElementById('excelFile');
        const fileNameSpan = document.getElementById('fileName');
        const clearDataBtn = document.getElementById('clearData');
        const exportExcelBtn = document.getElementById('exportExcel');
        const sheet2TableBody = document.getElementById('sheet2TableBody');
        const fechaCierreSpan = document.getElementById('fechaCierre');
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        const passwordError = document.getElementById('passwordError');
        const fechaDesdeInput = document.getElementById('fechaDesde');
        const fechaHastaInput = document.getElementById('fechaHasta');
        const aplicarFiltroBtn = document.getElementById('aplicarFiltro');
        const limpiarFiltroBtn = document.getElementById('limpiarFiltro');
        const totalGuiasSpan = document.getElementById('totalGuias');
        const guiasVigentesSpan = document.getElementById('guiasVigentes');
        const guiasAnuladasSpan = document.getElementById('guiasAnuladas');
        const totalSellosSpan = document.getElementById('totalSellos');
        const totalPesoNetoSpan = document.getElementById('totalPesoNeto');
        const destinatariosList = document.getElementById('destinatariosList');
        const transportistasList = document.getElementById('transportistasList');
        const scrollTopBtn = document.getElementById('scrollTopBtn');

        // Contraseña para eliminar datos
        const DELETE_PASSWORD = "230304";

        // Formatear fecha
        function formatFecha(fecha) {
            if (!fecha) return '-';
            
            // Si es un objeto Date
            if (fecha instanceof Date) {
                return `${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth()+1).toString().padStart(2, '0')}/${fecha.getFullYear()}`;
            }
            
            // Si es un string ISO (de Excel)
            if (typeof fecha === 'string' && fecha.includes('T')) {
                const dateObj = new Date(fecha);
                return formatFecha(dateObj);
            }
            
            // Si es un número (serial de Excel)
            if (typeof fecha === 'number') {
                // Convertir serial de Excel a fecha
                const dateObj = new Date((fecha - (25567 + 2)) * 86400 * 1000);
                return formatFecha(dateObj);
            }
            
            // Si ya está en formato string pero no es ISO
            return fecha;
        }

        // Convertir string a fecha (solo fecha, sin hora)
        function parseFechaToDate(fechaStr) {
            if (!fechaStr || fechaStr === '-') return null;
            
            // Si ya es un objeto Date
            if (fechaStr instanceof Date) {
                return new Date(fechaStr.getFullYear(), fechaStr.getMonth(), fechaStr.getDate());
            }
            
            // Intentar parsear diferentes formatos
            try {
                // Formato dd/mm/yyyy
                if (fechaStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const [day, month, year] = fechaStr.split('/');
                    return new Date(year, month - 1, day);
                }
                
                // Formato yyyy-mm-dd (input date)
                if (fechaStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return new Date(fechaStr);
                }
                
                // Formato ISO
                if (fechaStr.includes('T')) {
                    const dateObj = new Date(fechaStr);
                    return new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
                }
                
                // Si es un número (serial de Excel)
                if (typeof fechaStr === 'number') {
                    const dateObj = new Date((fechaStr - (25567 + 2)) * 86400 * 1000);
                    return new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
                }
            } catch {
                return null;
            }
            
            return null;
        }

        // Contar sellos (cada número cuenta como 1)
        function contarSellos(sellosStr) {
            if (!sellosStr || sellosStr === '-') return 0;
            
            // Extraer todos los números del string
            const numeros = sellosStr.match(/\d+/g);
            return numeros ? numeros.length : 0;
        }

        // Actualizar resumen de datos
        function updateSummary(data) {
            const total = data.length;
            const vigentes = data.filter(g => g.estado && g.estado.toLowerCase().includes('vigente')).length;
            const anuladas = data.filter(g => g.estado && g.estado.toLowerCase().includes('anulada')).length;
            
            let totalSellos = 0;
            let totalPesoNeto = 0;
            
            data.forEach(guia => {
                totalSellos += contarSellos(guia.sellos);
                
                // Sumar peso neto si es un número
                if (guia.pesoNeto && !isNaN(guia.pesoNeto)) {
                    totalPesoNeto += Number(guia.pesoNeto);
                }
            });
            
            totalGuiasSpan.textContent = total;
            guiasVigentesSpan.textContent = vigentes;
            guiasAnuladasSpan.textContent = anuladas;
            totalSellosSpan.textContent = totalSellos;
            totalPesoNetoSpan.textContent = totalPesoNeto.toFixed(2);
            
            // Actualizar destinatarios y transportistas
            updateDestinatarios(data);
            updateTransportistas(data);
        }

        // Actualizar listado de destinatarios
        function updateDestinatarios(data) {
            const destinatarios = {};
            
            data.forEach(guia => {
                if (guia.destinatario && guia.destinatario !== '-') {
                    destinatarios[guia.destinatario] = (destinatarios[guia.destinatario] || 0) + 1;
                }
            });
            
            const destinatariosArray = Object.entries(destinatarios).sort((a, b) => b[1] - a[1]);
            
            if (destinatariosArray.length === 0) {
                destinatariosList.innerHTML = '<span class="destinatario-tag">No hay datos</span>';
                return;
            }
            
            let html = '';
            destinatariosArray.forEach(([destinatario, count]) => {
                html += `<span class="destinatario-tag" title="${count} guía(s)">${destinatario} (${count})</span>`;
            });
            
            destinatariosList.innerHTML = html;
        }

        // Actualizar listado de transportistas
        function updateTransportistas(data) {
            const transportistas = {};
            
            data.forEach(guia => {
                if (guia.transportista && guia.transportista !== '-') {
                    transportistas[guia.transportista] = (transportistas[guia.transportista] || 0) + 1;
                }
            });
            
            const transportistasArray = Object.entries(transportistas).sort((a, b) => b[1] - a[1]);
            
            if (transportistasArray.length === 0) {
                transportistasList.innerHTML = '<span class="transportista-tag">No hay datos</span>';
                return;
            }
            
            let html = '';
            transportistasArray.forEach(([transportista, count]) => {
                html += `<span class="transportista-tag" title="${count} guía(s)">${transportista} (${count})</span>`;
            });
            
            transportistasList.innerHTML = html;
        }

        // Filtrar datos por fecha de emisión
        function filterByDate() {
            const fechaDesde = parseFechaToDate(fechaDesdeInput.value);
            const fechaHasta = parseFechaToDate(fechaHastaInput.value);
            
            if (!fechaDesde && !fechaHasta) {
                filteredData = [...guiasData];
                updateTable();
                updateSummary(filteredData);
                return;
            }
            
            filteredData = guiasData.filter(guia => {
                const fechaGuia = parseFechaToDate(guia.fechaEmision);
                if (!fechaGuia) return false;
                
                // Verificar si está en el rango
                const afterDesde = !fechaDesde || fechaGuia >= fechaDesde;
                const beforeHasta = !fechaHasta || fechaGuia <= fechaHasta;
                
                return afterDesde && beforeHasta;
            });
            
            updateTable();
            updateSummary(filteredData);
        }

        // Cargar datos desde Excel
        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            fileNameSpan.textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Tomar la primera hoja
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convertir a JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // Procesar los datos
                const nuevosDatos = jsonData.map(item => ({
                    id: Date.now() + Math.random().toString(36).substr(2, 9), // ID único
                    numeroGuia: item['Nro Guía'] || item['Nro Guia'] || item['NroGuía'] || item['NroGuia'] || '-',
                    fechaEmision: item['Fecha Emisión'] || item['FechaEmisión'] || item['Fecha'] || '-',
                    tipo: item['Tipo'] || '-',
                    estado: item['Estado'] || '-',
                    operador: item['Operador'] || '-',
                    destinatario: item['Destinatario'] || '-',
                    transportista: item['Transportista'] || '-',
                    conductor: item['Conductor'] || item['Chofer'] || '-',
                    patenteCamion: item['Pat. Camión'] || item['PatCamión'] || item['Patente'] || '-',
                    patenteAcoplado: item['Pat. Acoplado'] || item['PatAcoplado'] || '-',
                    producto: item['Producto'] || '-',
                    pesoBruto: item['Peso Bruto'] || item['PesoBruto'] || '-',
                    pesoTara: item['Peso Tara'] || item['PesoTara'] || '-',
                    pesoNeto: item['Peso Neto'] || item['PesoNeto'] || '-',
                    sellos: item['Sellos'] || '-'
                }));
                
                // Agregar a los datos existentes (no reemplazar)
                guiasData = [...guiasData, ...nuevosDatos];
                filteredData = [...guiasData];
                
                // Actualizar la tabla y resumen
                updateTable();
                updateSummary(filteredData);
                
                // Guardar en localStorage
                localStorage.setItem('guiasDespachoData', JSON.stringify(guiasData));
                
                // Actualizar fecha de cierre
                updateFechaCierre();
                
                // Limpiar filtros
                fechaDesdeInput.value = '';
                fechaHastaInput.value = '';
            };
            reader.readAsArrayBuffer(file);
        });

        // Mostrar modal para confirmar eliminación con contraseña
        clearDataBtn.addEventListener('click', function() {
            if (guiasData.length === 0) {
                alert('No hay datos para eliminar.');
                return;
            }
            
            passwordModal.style.display = 'flex';
            passwordInput.value = '';
            passwordError.style.display = 'none';
        });

        // Cancelar eliminación
        cancelDeleteBtn.addEventListener('click', function() {
            passwordModal.style.display = 'none';
        });

        // Confirmar eliminación con contraseña
        confirmDeleteBtn.addEventListener('click', function() {
            if (passwordInput.value === DELETE_PASSWORD) {
                // Eliminar todos los datos
                guiasData = [];
                filteredData = [];
                updateTable();
                updateSummary(filteredData);
                localStorage.removeItem('guiasDespachoData');
                excelFileInput.value = '';
                fileNameSpan.textContent = 'No se ha seleccionado archivo';
                fechaCierreSpan.textContent = new Date().toLocaleDateString('es-ES');
                
                // Limpiar filtros
                fechaDesdeInput.value = '';
                fechaHastaInput.value = '';
                
                // Cerrar modal
                passwordModal.style.display = 'none';
            } else {
                // Mostrar error de contraseña
                passwordError.style.display = 'block';
            }
        });

        // Aplicar filtro por fecha
        aplicarFiltroBtn.addEventListener('click', filterByDate);

        // Limpiar filtro
        limpiarFiltroBtn.addEventListener('click', function() {
            fechaDesdeInput.value = '';
            fechaHastaInput.value = '';
            filteredData = [...guiasData];
            updateTable();
            updateSummary(filteredData);
        });

        // Actualizar tabla
        function updateTable() {
            const dataToShow = filteredData.length > 0 ? filteredData : guiasData;
            
            if (dataToShow.length === 0) {
                sheet2TableBody.innerHTML = `
                    <tr>
                        <td colspan="15" style="text-align: center;">No hay datos disponibles. Cargue un archivo Excel.</td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            dataToShow.forEach(guia => {
                tableHTML += `
                    <tr>
                        <td>${guia.numeroGuia}</td>
                        <td>${formatFecha(guia.fechaEmision)}</td>
                        <td>${guia.tipo}</td>
                        <td>${guia.estado}</td>
                        <td>${guia.operador}</td>
                        <td>${guia.destinatario}</td>
                        <td>${guia.transportista}</td>
                        <td>${guia.conductor}</td>
                        <td>${guia.patenteCamion}</td>
                        <td>${guia.patenteAcoplado}</td>
                        <td>${guia.producto}</td>
                        <td>${guia.pesoBruto}</td>
                        <td>${guia.pesoTara}</td>
                        <td>${guia.pesoNeto}</td>
                        <td>${guia.sellos}</td>
                    </tr>
                `;
            });
            
            sheet2TableBody.innerHTML = tableHTML;
        }

        // Actualizar fecha de cierre
        function updateFechaCierre() {
            if (guiasData.length > 0) {
                // Usar la fecha más reciente
                const ultimaFecha = guiasData.reduce((latest, current) => {
                    try {
                        const currentDate = parseFechaToDate(current.fechaEmision);
                        return currentDate > latest ? currentDate : latest;
                    } catch {
                        return latest;
                    }
                }, new Date(0));
                
                if (ultimaFecha.getTime() > 0) {
                    fechaCierreSpan.textContent = ultimaFecha.toLocaleDateString('es-ES');
                    return;
                }
            }
            fechaCierreSpan.textContent = new Date().toLocaleDateString('es-ES');
        }

        // Mostrar/ocultar botón de scroll
        window.addEventListener('scroll', function() {
            if (window.pageYOffset > 300) {
                scrollTopBtn.classList.add('visible');
            } else {
                scrollTopBtn.classList.remove('visible');
            }
        });

        // Ir al principio al hacer clic en el botón
        scrollTopBtn.addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Exportar a Excel
        exportExcelBtn.addEventListener('click', function() {
            if (guiasData.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }

            // Preparar los datos para exportar
            const dataToExport = (filteredData.length > 0 ? filteredData : guiasData).map(guia => ({
                'Nro Guía': guia.numeroGuia,
                'Fecha Emisión': formatFecha(guia.fechaEmision),
                'Tipo': guia.tipo,
                'Estado': guia.estado,
                'Operador': guia.operador,
                'Destinatario': guia.destinatario,
                'Transportista': guia.transportista,
                'Conductor': guia.conductor,
                'Pat. Camión': guia.patenteCamion,
                'Pat. Acoplado': guia.patenteAcoplado,
                'Producto': guia.producto,
                'Peso Bruto': guia.pesoBruto,
                'Peso Tara': guia.pesoTara,
                'Peso Neto': guia.pesoNeto,
                'Sellos': guia.sellos
            }));

            // Crear hoja de trabajo
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Guías de Despacho");
            
            // Generar archivo Excel
            const fechaExportacion = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(wb, `Guias_Despacho_${fechaExportacion}.xlsx`);
        });

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            const savedData = localStorage.getItem('guiasDespachoData');
            if (savedData) {
                guiasData = JSON.parse(savedData);
                filteredData = [...guiasData];
                updateTable();
                updateSummary(filteredData);
                updateFechaCierre();
            }
            
            // Establecer fecha máxima como hoy
            const today = new Date().toISOString().split('T')[0];
            fechaDesdeInput.max = today;
            fechaHastaInput.max = today;
        });
    </script>
</body>
</html>
